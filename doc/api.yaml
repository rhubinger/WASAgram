openapi: 3.0.0
servers:
  - url: "http://localhost:3000"
info:
  title: WASAgram
  description: |-
    This API is for the WASAgram Webapp. 
  version: 1.0.0
tags:
  - name: Login
  - name: User
  - name: Fotos
  - name: Image
paths:
  /login:
    post:
      tags: ["Login"]
      summary: Logs in the user
      description: |
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned.
      operationId: doLogin
      requestBody:
        description: User details
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "Alan Turing"
                  pattern: 'ˆ.*?$'
                  minLength: 3
                  maxLength: 16
        required: true
      responses:
        "201":
          description: User log-in action successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  identifier:
                    type: string
                    example: "qlzf1964sdlk"
        "400": { $ref: "#/components/responses/BadRequest" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /user/{uid}/username:
    parameters:
      - $ref: "#/components/parameters/userId"
    post:
      tags: ["User"]
      summary: Change the username
      description: |
        Change the username of a user. Only the user itself can change his username.
      security:
        - bearerAuth: []
      requestBody:
        description: New username
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "Alan Turing"
                  pattern: "ˆ.*?$"
                  minLength: 3
                  maxLength: 16
        required: true
      responses:
        "200": { description: Username changed successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
  
  /user/{uid}/followed:
    parameters:
      - $ref: "#/components/parameters/userId"
    get:
      tags: ["User"]
      summary: Get all users which the user follows
      description: |
        Obtain all accounts and their ids the user follows.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            An array of usernames and their ids.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/userlist"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
                  
  /user/{uid}/followers:
    parameters:
      - $ref: "#/components/parameters/userId"
    get:
      tags: ["User"]
      summary: Get all users which follow the user
      description: |
        Obtain all users and their ids which follow the user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            An array of usernames which follow the user.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/userlist"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
                  
  /user/{uid}/followers/{fid}:
    parameters:
      - $ref: "#/components/parameters/userId"
      - $ref: "#/components/parameters/followerId"
    put:
      tags: ["User"]
      summary: Follow a user
      description: |
        Follow another user.
        The userId specifies the followed user,
        the followerId specifies the user which wants to follow the other user.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Followed user successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: No user found}
        "500": { $ref: "#/components/responses/InternalServerError" }
    delete:
      tags: ["User"]
      summary: Unfollow a user
      description: |
        Unfollow another user.
        The userId specifies the followed user,
        the followerId specifies the user which wants to follow the other user.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Unfollowed user successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
  
  /user/{uid}/banned/{bid}:
    parameters:
    - $ref: "#/components/parameters/userId"
    - $ref: "#/components/parameters/bannedId"
    put:
      tags: ["User"]
      summary: Ban a user
      description: |
        Ban another user.
        The userId specifies the the banning user, 
        the bannedId specifies the user which gets banned.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Banned user successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
    delete:
      tags: ["User"]
      summary: Unban a user
      description: |
        Unban another user.
        The userId specifies the the banning user, 
        the bannedId specifies the user which gets unbanned.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Unbanned user successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
  
  /user/{uid}/banned:
    parameters:
      - $ref: "#/components/parameters/userId"
    get:
      tags: ["User"]
      summary: Get all users which a user banned
      description: |
        Obtain all users which got banned by a user.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            An array of usernames and their ids.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/userlist"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
                  
  /user/{uid}:
    parameters:
      - $ref: "#/components/parameters/userId"
    get:
      tags: ["User"]
      summary: Get a users profile data
      description: |
        Obtain the userdata and a list of fotos from the specified user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            Userdata and an array of fotos posted by the user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/profile"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
  
  /user/{uid}/stream:
    parameters:
      - $ref: "#/components/parameters/userId"
    get:
      tags: ["User"]
      summary: Get the stream of a user
      description: |
        Obtain all posts made by accounts which the user follows
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            An array of fotos which were posted by the users followed accounts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/stream"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: User not found }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /posts:
    post:
      tags: ["Fotos"]
      summary: Create a new post
      description: |
        Post a foto with caption to a users account. 
        The posted foto will then appear on the profile of the user and in the streams of his followers.
      security:
        - bearerAuth: []
      requestBody:
        description: New foto
        content:
          multipart/form-data:
            schema:
              allOf:
                - $ref: "#/components/schemas/post"
                - type: object
                  properties:
                    image:
                      type: string
                      format: binary
        required: true
      responses:
        "200": { description: Post created successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /posts/{pid}:
    parameters:
      - $ref: "#/components/parameters/postId"
    get:
      tags: ["Fotos"]
      summary: Get a Foto
      description: |
        Get the foto with id fid.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            The posts metadata
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/post"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Post not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
        
    delete:
      tags: ["Fotos"]
      summary: Delete a Post
      description: |
        Remove a post from a users account. 
        The postId specifies the post.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Post deleted successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Post not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
  
  /posts/{pid}/likes:
    parameters:
      - $ref: "#/components/parameters/postId"
    get:
      tags: ["Fotos"]
      summary: Get the users that liked a foto
      description: |
        Get the users and their ids which liked the foto.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            TODO
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/userlist"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Post not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
                  
  /posts/{pid}/likes/{lid}:
    parameters:
      - $ref: "#/components/parameters/postId"
      - $ref: "#/components/parameters/likeId"
    put:
      tags: ["Fotos"]
      summary: Like a Foto
      description: |
        Like a post from another users account. 
        The postId specifies the post from the users account, the likeId is the userId of the liking user.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Post liked successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Resource not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
    delete:
      tags: ["Fotos"]
      summary: Unlike a Foto
      description: |
        Remove a like from another users foto. 
        The postId specifies the foto from the users account, the likeId is the userId of the unliking user.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Post unliked successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Resource not found }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /posts/{pid}/comments:
    parameters:
      - $ref: "#/components/parameters/postId"
    post:
      tags: ["Fotos"]
      summary: Comment a post
      description: |
        Comment a post from another users account. 
        The postId specifies the post.
      security:
        - bearerAuth: []
      requestBody:
        description: User details
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/comment"
      responses:
        "200": { description: Comment created successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Post not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
    get:
      tags: ["Fotos"]
      summary: Get the commments of a foto
      description: |
        Get the comments of a foto
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            The foto with id fid as well as its metadata
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/commentlist"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Post not found }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /posts/{pid}/comments/{cid}:
    parameters:
      - $ref: "#/components/parameters/postId"
      - $ref: "#/components/parameters/commentId"
    delete:
      tags: ["Fotos"]
      summary: Uncomment a Foto
      description: |
        Delete a previously made comment on a foto from another users account. 
        The postId specifies the post, the commentId specifies the id of the comment.
      security:
        - bearerAuth: []
      responses:
        "200": { description: Comment delted successfully }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Resource not found }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /image/{pid}/:
    parameters:
      - $ref: "#/components/parameters/postId"
    get:
      tags: ["Image"]
      summary: Get the image of a Post
      description: |
        Get the image of the post with the post id pid.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: |
            The foto with id fid as well as its metadata
          content:
            image/png:
              schema:
                type: string
                format: binary
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/UnauthorizedRequest" }
        "404": { description: Image not found }
        "500": { $ref: "#/components/responses/InternalServerError" }
                  
components:
  parameters:
    userId:
      schema:
        type: string
        example: "qlzf1964sdlk"
        readOnly: true
      name: uid
      in: path
      required: true
      description: The user id (uid) is an integer, that uniquely identifies a user.
    followerId:
      schema:
        type: string
        example: "qlfj5037flng"
        readOnly: true
      name: fid
      in: path
      required: true
      description: The follower id (fid) is the user id (uid) of the follower.
    bannedId:
      schema:
        type: string
        example: "eolg4078rngk"
        readOnly: true
      name: bid
      in: path
      required: true
      description: The banned id (bid) is the user id (uid) of the banned user.
    postId:
      schema:
        type: string
        example: "qlvh1857rovh"
        readOnly: true
      name: pid
      in: path
      required: true
      description: The post id (fid) is an integer, that uniquely identifies a post.
    likeId:
      schema:
        type: string
        example: "dpvk1047dovl"
        readOnly: true
      name: lid
      in: path
      required: true
      description: The like id (lid) is the user id (uid) of the user that liked the post.
    commentId:
      schema:
        type: string
        example: "dpvk2047fpwv"
        readOnly: true
      name: cid
      in: path
      required: true
      description: The comment id (cid) is an integer, thath uniquely identifies a comment.
        
  schemas:
    user:
      type: object
      properties:
        userId:
          type: string
          example: "dltk4078glfj"
        name:
          type: string
          example: "KonradZuse"
        followers:
          type: integer
          example: 15400
          minimum: 0
        followed:
          type: integer
          example: 530
          minimum: 0
    stream:
      type: array
      items: 
        $ref: "#/components/schemas/post"    
    profile:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/user"
        posts:
          type: array
          items: 
            $ref: "#/components/schemas/post"
    post:
      type: object
      properties:
        poster:
          $ref: "#/components/schemas/user"
        date-time:
          type: string
          format: date-time
        caption:
          type: string
          example: "Nice day at the beach."
          minLength: 1
          maxLength: 140
        likes:
          type: integer
          example: 14
          minimum: 0
        comments:
          type: integer
          example: 3
          minimum: 0
    userlist:
      type: object
      properties:
        length:
          type: integer
          example: 8
          minimum: 1
        list:
          type: array
          items:
            $ref: "#/components/schemas/user"
    comment:
      type: object
      properties:
        poster:
          $ref: "#/components/schemas/user"
        fotoId:
          type: string
          example: "qlzf1964sdlk"
        date-time:
          type: string
          format: date-time
        comment:
          type: string
          example: "Looks nice!"
          minLength: 1
          maxLength: 140
          
    commentlist:
      type: object
      properties:
        length:
          type: integer
          example: 3
          minimum: 1
        list:
          type: array
          items:
            $ref: "#/components/schemas/comment"
        
  responses:
    BadRequest:
      description: |-
        The request was not compliant with the documentation
        (eg. missing fields, etc).
    UnauthorizedRequest:
      description: |-
        The requesting party was not authorized to access the resource.
    InternalServerError:
      description: |-
        The server encountered an internal error.
        Further info in server logs. 
        comment:
          type: string
          
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer